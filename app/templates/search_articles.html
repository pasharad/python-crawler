{% extends "base.html" %}

{% block content %}
<div class="container no-width">
    <h2>Ø¬Ø³ØªØ¬ÙˆÛŒ Ù…Ù‚Ø§Ù„Ù‡â€ŒÙ‡Ø§</h2>

    <!-- ÙØ±Ù… Ø§Ù†ØªØ®Ø§Ø¨ ØªØ§Ø±ÛŒØ® -->
    <div class="form-section">
        <label for="date">ØªØ§Ø±ÛŒØ®:</label>
        <input type="date" id="date" name="date" required>
        <button id="search-btn">ğŸ” Ø¬Ø³ØªØ¬Ùˆ</button>
    </div>

    
    <!-- Ø¬Ø¯ÙˆÙ„ Ù…Ù‚Ø§Ù„Ø§Øª -->
    <div style="overflow-x: auto;">
    <table id="articles-table">
        <thead>
            <tr>
                <th>Ø¹Ù†ÙˆØ§Ù†</th>
                <th>Ù„ÛŒÙ†Ú©</th>
                <th>ØªØ§Ø±ÛŒØ®</th>
                <th>Ù…ØªÙ†</th>
                <th>Ø®Ù„Ø§ØµÙ‡</th>
                <th>Ø®Ù„Ø§ØµÙ‡ Ø¯ÙˆÙ…</th>
                <th>Ù…ØªÙ† ØªØ±Ø¬Ù…Ù‡ Ø´Ø¯Ù‡</th>
                <th>Ù…ØªÙ† ØªØ±Ø¬Ù…Ù‡ Ø´Ø¯Ù‡ Ø¯ÙˆÙ…</th>
                <th>Ù…Ù†Ø¨Ø¹</th>
                <th> Ù†Ø´Ø§Ù†Ù‡ Ù‡Ø§</th>
                <th id="type">Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    </div>
</div>

<style>
    .form-section {
        margin: 40px 0;
        display: flex;
    }
    input[type="date"] {
        padding: 6px;
        margin-left: 6px;
        border: 1px solid #4a0eb9;
        border-radius: 4px;
    }
    #search-btn {
        padding: 6px 12px;
        border: none;
        background-color: #007BFF;
        color: white;
        border-radius: 4px;
        cursor: pointer;
    }
    #search-btn:hover {
        background-color: #0056b3;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        
    }
    table th, table td {
        border: 1px solid #fafafa;
        padding: 2px;
        text-align: right;
        width: auto;
    }
    table th {
        background-color: #4a0eb9;
    }
    table tr:nth-child(even) {
        background-color: #0a56d0;
    }
    table a {
        color: #007BFF;
        text-decoration: none;
    }
    table a:hover {
        text-decoration: underline;
    }

    table th:nth-child(1),
    table td:nth-child(1) {
    min-width: 150px;
    text-align: left; /* Ø³ØªÙˆÙ† Ø¹Ù†ÙˆØ§Ù† */
    }

    table th:nth-child(2),
    table td:nth-child(2) {
    min-width: 120px; /* Ø³ØªÙˆÙ† Ù„ÛŒÙ†Ú© */
    }

    table th:nth-child(3),
    table td:nth-child(3) {
    min-width: 200px; /* Ø³ØªÙˆÙ† ØªØ§Ø±ÛŒØ® */
    }

    table th:nth-child(4),
    table td:nth-child(4) {
    min-width: 300px;
    text-align: left; /* Ø³ØªÙˆÙ† Ù…ØªÙ† */
    }

    table th:nth-child(5),
    table td:nth-child(5) {
    min-width: 250px;
    text-align: left; /* Ø³ØªÙˆÙ† Ø®Ù„Ø§ØµÙ‡ */
    }

    table th:nth-child(6),
    table td:nth-child(6) {
    min-width: 250px;
    text-align: left; /* 2Ø³ØªÙˆÙ† Ø®Ù„Ø§ØµÙ‡ */
    }

    table th:nth-child(7),
    table td:nth-child(7) {
    min-width: 300px; /* Ø³ØªÙˆÙ† Ù…ØªÙ† ØªØ±Ø¬Ù…Ù‡ */
    }

    table th:nth-child(8),
    table td:nth-child(8) {
    min-width: 300px; /* 2Ø³ØªÙˆÙ† Ù…ØªÙ† ØªØ±Ø¬Ù…Ù‡ */
    }

    table th:nth-child(9),
    table td:nth-child(9) {
    min-width: 50px; /* Ø³ØªÙˆÙ† Ù…Ù†Ø¨Ø¹  */
    }

    table th:nth-child(10),
    table td:nth-child(10) {
    min-width: 150px; /* Ø³ØªÙˆÙ† Ù†Ø´Ø§Ù†Ù‡ Ù‡Ø§  */
    }

    table th:nth-child(11),
    table td:nth-child(11) {
    min-width: 150px; /* Ø³ØªÙˆÙ† Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ  */
    }

</style>

<script>
document.getElementById("search-btn").addEventListener("click", async () => {
    const date = document.getElementById("date").value;
    if (!date) {
        alert("Ù„Ø·ÙØ§ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.");
        return;
    }

    try {
        // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡ API
        const res = await fetch(`/api/search_articles/${date}`);
        if (!res.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§");

        const data = await res.json();
        const tbody = document.querySelector("#articles-table tbody");
        const types = await fetch(`/api/types`, {method: "GET"}).then(r => r.json());
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„ Ù‚Ø¨Ù„ÛŒ
        tbody.innerHTML = "";

        // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„ Ø¬Ø¯ÛŒØ¯
        data.forEach(article => {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${article.title}</td>
                <td><a href="${article.url}" target="_blank">Ù„ÛŒÙ†Ú©</a></td>
                <td>${article.date}</td>
                <td>${article.description.slice(0, 100)}...</td>
                <td>${article.summery || ""}</td>
                <td>${article.translated_text || ""}</td>
                <td>${article.source || ""}</td>
                <td>${article.tags || ""}</td>
                <td>${article.tags || ""}</td>
                <td>${article.tags || ""}</td>
                <td>
                    <select data-id="${article.id}">
                        <option value="" ${!article.type_id ? "selected" : ""}>None</option>
                        ${types.map(type => `
                            <option value="${type.id}" ${article.type_id === type.id ? "selected" : ""}>
                                ${type.type_name}
                            </option>
                        `).join('')}
                    </select>
                </td>
            `;
            tbody.appendChild(row);
        });

        // Ù‡Ù†Ø¯Ù„ ØªØºÛŒÛŒØ± Type Ø¯Ø± Ø³Ù„Ú©Øª Ø¨Ø§Ú©Ø³
        document.querySelectorAll("select[data-id]").forEach(sel => {
            sel.addEventListener("change", async () => {
                const id = sel.dataset.id;
                const type_id = sel.value;

                await fetch(`/api/articles/set_type/${id}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ type_id })
                });
            });
        });

    } catch (err) {
        console.error(err);
        alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ù‚Ø§Ù„Ù‡â€ŒÙ‡Ø§");
    }
});
</script>
{% endblock %}